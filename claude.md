# K'UHUL Ï€ Kernel â€” Security Cheat Sheet

## System Law (LOCKED)

```
MODEL â‰  FILE       TOKENS = GLYPHS      TRUTH = EVENT
MODEL â‰  GPU        THOUGHT = SIGNAL     VALIDITY = INVARIANT
MODEL â‰  TOKENS     MODEL = FIELD        ANSWER = CLUSTER COLLAPSE
```

**Mode:** `FIELD_ONLY` â€” No tensors, no CUDA, no tokenizer, no model loading.

---

## Architecture (3-File Rule)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        index.html                           â”‚
â”‚                (Ghost Shell / Canvas / UI)                  â”‚
â”‚   - No logic, No authority, All actions â†’ sw.js             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ fetch / postMessage
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         sw.js                                â”‚
â”‚                  K'UHUL Ï€ KERNEL (SEALED)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ localhost (optional)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  mx2lm-host.exe (OPTIONAL)                  â”‚
â”‚        Python / Native Acceleration / Model Bridge           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Glyph Table (Weight Carriers)

| Glyph | Base Value | Description |
|-------|------------|-------------|
| `@` | 1.0 | Single weight |
| `@@` | 2.0 | Double weight |
| `@@@` | 3.0 | Triple weight |
| `Ï€` | 3.14159... | Pi constant |
| `Ï†` | 1.618... | Golden ratio |
| `e` | 2.718... | Euler's number |
| `Ï„` | 6.283... | Tau (2Ï€) |
| `â¤` | 0.87 | Forward flow |
| `â†»` | 0.93 | Cycle/refresh |
| `âŸ²` | 0.76 | Loop/return |

---

## Research Glyphs (Emoji Opcodes)

| Glyph | Operation | Route |
|-------|-----------|-------|
| ğŸ§­ | `research.search` | `/research/search` |
| ğŸ” | `research.source` | `/research/source` |
| ğŸ§¾ | `research.audit` | `/research/audit` |
| ğŸ§  | `research.agents` | `/research/agents` |
| ğŸ“š | source: wikipedia | â€” |
| ğŸ™ | source: github | â€” |
| ğŸ“° | source: rss | â€” |

---

## ASM v1.0 â€” Atomic Symbolic Markup

### Core Invariant
```
Symbols live as ATTRIBUTES, not tag names.
<div âš›ï¸D âŸMC> âœ…
<âš›ï¸D>           âŒ (invalid HTML)
```

### Element Symbols (âš›ï¸X)

| Symbol | HTML Tag |
|--------|----------|
| `âš›ï¸D` | `div` |
| `âš›ï¸H` | `header` |
| `âš›ï¸M` | `main` |
| `âš›ï¸N` | `nav` |
| `âš›ï¸C` | `div` (card) |
| `âš›ï¸S` | `section` |
| `âš›ï¸A` | `article` |
| `âš›ï¸F` | `footer` |
| `âš›ï¸B` | `button` |
| `âš›ï¸I` | `span` |
| `âš›ï¸L` | `a` (link) |
| `âš›ï¸P` | `p` |
| `âš›ï¸T` | `h1` (title) |

### Composition Tokens (âŸX)
- `âŸMC` â€” Main container
- `âŸC0`, `âŸC1` â€” Card variants
- `âŸN0`, `âŸN1` â€” Nav items
- `âŸF` â€” Flex
- `âŸG2`, `âŸG3` â€” Grid columns
- `âŸAC` â€” Align center
- `âŸJSB` â€” Justify space-between
- `âŸP4` â€” Padding level 4

### Output Modes
```js
ASM.setOptions({ compositionMode: 'attrs' });  // Keep âŸXYZ attrs (CSS selectors work)
ASM.setOptions({ compositionMode: 'data' });   // Collapse to data-âŸ="..."
ASM.setOptions({ compositionMode: 'class' });  // Convert to classes
```

---

## XCFE Control Law (LOCKED)

```
âš¡ collapses truth â†’ proof binds truth to policy â†’
branch gate acknowledges proof â†’ replay verifier decides reality

No @then/@else branch is valid unless gated by verified
âš¡ proof_hash under pinned epoch policy hash.
```

### Hash Format
```
h:<algo>:<hex>
h:sha256:a1b2c3d4e5f6...
```

### Proof Rule
```
proof_hash = H(input_hash || ":" || truth)
           = H("h:sha256:abc123:true")
```

### Key Structures

**@epoch_policy**
```json
{
  "@epoch_policy": {
    "epoch": 0,
    "policy_id": "mx2lm-v1",
    "policy_hash": "h:sha256:...",
    "canon": "MX2_CANON_JSON_v1.0",
    "rules": {
      "branch_gate_requires_lightning": true,
      "proof_algo": "sha256",
      "proof_rule": "proof_hash = H(input_hash || ':' || truth)"
    }
  }
}
```

**@âš¡ Lightning Event**
```json
{
  "@âš¡": [{
    "id": "expr-001",
    "epoch": 0,
    "tick": 1,
    "runtime": "âš¡",
    "resolved": true,
    "truth": true,
    "policy_hash": "h:sha256:...",
    "proof": {
      "input_hash": "h:sha256:...",
      "proof_hash": "h:sha256:...",
      "bundle_hash": "h:sha256:..."
    }
  }]
}
```

**@xcfe.branch_gate**
```json
{
  "@xcfe.branch_gate": {
    "expr_ref": "expr-001",
    "epoch": 0,
    "policy_hash": "h:sha256:...",
    "ok": true,
    "truth": true,
    "selected": "@then",
    "proof_hash": "h:sha256:..."
  }
}
```

**@rotation_replay_result**
```json
{
  "@rotation_replay_result": {
    "ok": true,
    "policy_hash": "h:sha256:...",
    "proof_hash": "h:sha256:...",
    "failure_stage": null,
    "verified": {
      "epoch_policy": 1,
      "lightning": 5,
      "branch_gate": 3
    }
  }
}
```

### Failure Stages
- `epoch_policy` â€” Policy hash mismatch
- `canon_mismatch` â€” Wrong canonicalization spec
- `lightning_verify` â€” No valid âš¡ events
- `branch_gate_verify` â€” Branch gate failed verification

---

## JavaCrypt Opcode Contract v1

### Message Shape (Sealed Interface)
```js
{
  __javacrypt__: true,  // Required flag
  v: 1,                 // Contract version
  id: "jc_abc123",      // Unique request ID
  t: 1703123456789,     // Timestamp
  op: "kernel.ping",    // Operation name
  payload: {}           // Operation-specific data
}
```

### Allowlist (Only These Operations Execute)
```
kernel.ping       audit.export      tape.put
tape.get          tape.list         cluster.run
cluster.status    agent.spawn       agent.list
research.fetch    research.search   pi.emit
pi.infer          host.probe        manifest.get
manifest.patch
```

### Validation
```js
function validate_opcode(block) {
  assert(block.__javacrypt__ === true);
  assert(JAVACRYPT.allowlist.has(block.op));
  assert(block.v === JAVACRYPT.v);
  assert(typeof block.id === 'string');
  assert(Number.isFinite(block.t));
}
```

---

## MX2 Canonical JSON v1.0

### Rules
1. **Stable key ordering** â€” Sort keys lexicographically (UTF-16)
2. **Number normalization**:
   - Integers: `"0"`, `"-12"`, `"42"`
   - Floats: Minimal decimal, no exponent, trim trailing zeros
   - `-0` â†’ `"0"`
3. **No whitespace** â€” Compact output
4. **Arrays preserve order**

### Implementation
```js
function canonValue(v) {
  if (v === null) return 'null';
  if (typeof v === 'boolean') return v ? 'true' : 'false';
  if (typeof v === 'number') return canonNumber(v);
  if (typeof v === 'string') return JSON.stringify(v);
  if (Array.isArray(v)) return '[' + v.map(canonValue).join(',') + ']';
  if (isPlainObject(v)) {
    const keys = Object.keys(v).sort();
    return '{' + keys.map(k =>
      JSON.stringify(k) + ':' + canonValue(v[k])
    ).join(',') + '}';
  }
  throw new Error('Unsupported type');
}
```

---

## Audit Log (Hash-Chain Journal)

### Chain Structure
```
GENESIS â†’ H(GENESIS|entry1) â†’ H(prev|entry2) â†’ ...
```

### Entry Shape
```js
{
  t: 1703123456789,
  type: "javacrypt.call",
  payload: { op: "kernel.ping" },
  meta: { kernel: "kuhul-pi-...", version: "1.2.6" },
  prev: "fnv1a32:abcd1234",
  hash: "fnv1a32:efgh5678"
}
```

### Hash Function (FNV-1a 32-bit)
```js
function hash_str(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = (h * 0x01000193) >>> 0;
  }
  return 'fnv1a32:' + h.toString(16).padStart(8, '0');
}
```

---

## Unified Runtime v4.1 (Core Loop)

### Execution Model
```
Pop â†’ Wo â†’ Sek â†’ Tick
```

| Phase | Action |
|-------|--------|
| **Pop** | Invoke agent from event queue |
| **Wo** | Mutate agent state |
| **Sek** | Sequence new event |
| **Tick** | Propagate signals, detect clusters |

### Agent Tick
```js
function tickAgent(agent) {
  // Sum glyph weights
  const weight = agent.glyphs.reduce((sum, g) => sum + (GLYPH[g] || 0), 0);

  // Update activation
  agent.state.activation += weight * 0.01;

  // Decay energy
  agent.state.energy *= 0.99;

  // Emit if threshold crossed
  if (agent.state.activation > 1) {
    emit(agent);
    agent.state.activation *= 0.5;
  }
}
```

### Cluster Detection
Agents cluster when activation difference < 0.2

### Answer = Cluster Collapse
```js
function collapse(cluster) {
  const totalWeight = members.reduce((s, a) =>
    s + a.glyphs.reduce((gs, g) => gs + (GLYPH[g] || 0), 0), 0);
  return { cluster: cluster.id, weight: totalWeight, collapsed: true };
}
```

---

## Research Packet Model

### Envelope Shape
```js
{
  'âŸv': 1,                    // Version
  '@t': Date.now(),           // Timestamp
  '@op': 'research.fetch',    // Operation
  '@q': 'query string',       // Query
  '@source': 'wikipedia',     // Source
  '@n': 10,                   // Max results
  '@mode': 'DIRECT',          // DIRECT | PROXY
  '@meta': {}                 // Optional metadata
}
```

### SHA-256 Proof
```js
async function sha256Proof(packet) {
  const json = stable_stringify(packet);
  const hash = await crypto.subtle.digest('SHA-256', utf8.enc.encode(json));
  const hex = Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, '0')).join('');
  return { proof: 'sha256:' + hex, packet };
}
```

### Cache Key
```js
function researchCacheKey(packet) {
  return `research:${packet['@source']}:${packet['@q']}:${packet['@n']}`;
}
```

---

## Key API Endpoints

| Route | Method | Description |
|-------|--------|-------------|
| `/health` | GET | Kernel health check |
| `/manifest.json` | GET | Dynamic manifest |
| `/_mx2/api/exec` | POST | JavaCrypt execution |
| `/_mx2/api/cluster/run` | POST | Run cluster job |
| `/_mx2/api/cluster/status` | GET | Cluster status |
| `/_mx2/api/pi/emit` | POST | Ï€ glyph emission |
| `/_mx2/api/pi/infer` | POST | Ï€ inference |
| `/_mx2/api/audit/export` | GET | Export audit log |
| `/research/search` | GET/POST | Research search |
| `/research/agents` | GET | List research agents |
| `/research/audit` | GET | Research audit log |

---

## Security Invariants Checklist

- [ ] All privileged ops go through JavaCrypt allowlist
- [ ] All state mutations audited via hash-chain
- [ ] No branch execution without verified âš¡ proof
- [ ] Policy hash pinned at epoch boundary
- [ ] Canonical JSON for all hashed objects
- [ ] Symbols as attributes, not tag names (ASM)
- [ ] No tensor/GPU/model file operations (FIELD_ONLY)
- [ ] External fetches via allowlisted domains only
- [ ] Payload size limits enforced
- [ ] Timeout limits on all async operations

---

## K'UHUL Ï€ Virtual Cluster v1.0

### Core Innovation
```javascript
// Traditional: 16GB weight storage
weights = load_from_disk("model.bin")

// K'UHUL Ï€: 0.5KB specification
weights = regenerate_weights(seed, Ï€, Ï†, position)
```

### Node State Machine
```
BOOTSTRAP â†’ DISCOVERING â†’ CONNECTING â†’ SYNCING â†’ READY
                                          â†“
                                      DEGRADED â†â†’ RECOVERING
                                          â†“
                                       OFFLINE
```

### Mathematical Regeneration
```javascript
f(x, c) = sin(x * c * Ï€) * cos(x * e) * (1 + Ï† * tanh(x))
```

### CRDT Sync Rules
- **Last-Write-Wins** with timestamp comparison
- **Vector Clock** tie-breaking by nodeId
- **Consensus Threshold**: 67% agreement

### Recovery Strategies (in order)
1. `strategyResyncState` â€” Clear and rebuild sync state
2. `strategyResetMathEngine` â€” Clear weight cache
3. `strategyHardReset` â€” Full node reset

### Virtual Cluster API
```js
VirtualCluster.getInstance(config)     // Get singleton
cluster.initialize()                   // Bootstrap â†’ Ready
cluster.regenerateWeights(layer, pos, dim) // Regenerate weights
cluster.verifyWeights(layer, pos, weights) // Verify consistency
cluster.syncState(key, value)          // CRDT set
cluster.getState(key)                  // CRDT get
cluster.mergeState(remote, nodeId)     // CRDT merge
cluster.recover()                      // Trigger recovery
cluster.status()                       // Full status
cluster.shutdown()                     // Graceful shutdown
```

---

## Quick Reference Functions

```js
// Hash object with canonical JSON
XCFE.hashObject(obj) â†’ { canon, hash: "h:sha256:..." }

// Verify replay stream
XCFE.replayVerify(stream) â†’ @rotation_replay_result

// Transform ASM markup
ASM.transform(root)
ASM.fromHTML(html, doc) â†’ DocumentFragment

// Emit Ï€ glyphs
Cluster.piEmit(query, steps) â†’ [{ glyph, strength, phase }]

// Run unified runtime
UnifiedRuntime.run(ticks) â†’ { answers: [...] }

// Virtual Cluster
VirtualCluster.getInstance() â†’ ClusterController
cluster.regenerateWeights(layer, pos, dim) â†’ Float32Array

// Create audit entry
audit_event(type, payload, meta) â†’ entry

// Validate JavaCrypt opcode
validate_opcode(block) â†’ true | throws
```
